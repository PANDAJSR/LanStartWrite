<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPT 联动控制</title>
    <style>
        :root {
            --bg-color: rgba(255, 255, 255, 0.95);
            --primary-color: #0078d4;
            --text-color: #333;
            --border-radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            --hover-bg: #f3f3f3;
            --active-bg: #e5e5e5;
            --danger-color: #d83b01;
        }

        body {
            margin: 0;
            padding: 10px;
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            background: transparent;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
            height: 100vh;
            box-sizing: border-box;
            user-select: none;
        }

        .ppt-control-panel {
            background: var(--bg-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* 顶部控制栏 */
        .control-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .nav-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            background: var(--hover-bg);
            border: none;
            border-radius: 6px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-color);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .btn:hover:not(:disabled) {
            background: var(--active-bg);
        }

        .btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #106ebe;
        }

        .btn-danger {
            color: var(--danger-color);
        }

        .btn-danger:hover:not(:disabled) {
            background: #fee9e9;
        }

        /* 页面信息 */
        .page-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .page-input-container {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .page-input {
            width: 40px;
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }

        /* 缩略图区域 */
        .thumbnail-container {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: thin;
            scrollbar-color: #ccc transparent;
        }

        .thumbnail-container::-webkit-scrollbar {
            height: 6px;
        }

        .thumbnail-container::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }

        .thumbnail-item {
            flex: 0 0 120px;
            aspect-ratio: 16/9;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            border: 2px solid transparent;
            cursor: pointer;
            position: relative;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform: scale(0.95);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .thumbnail-item:hover {
            transform: scale(1);
            background: #444;
        }

        .thumbnail-item.active {
            border-color: var(--primary-color);
            background: #444;
            transform: scale(1);
            box-shadow: 0 0 12px rgba(0, 120, 212, 0.4);
        }

        .thumbnail-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.3s ease;
        }

        .thumbnail-item.loading img {
            opacity: 0.3;
        }

        .thumbnail-num {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        /* 动画效果 */
        .fade-enter {
            opacity: 0;
            transform: translateY(10px);
        }
        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div class="ppt-control-panel fade-enter" id="panel">
        <div class="control-header">
            <div class="nav-buttons">
                <button class="btn" id="prevBtn" title="上一页">
                    <svg width="16" height="16" viewBox="0 0 16 16"><path fill="currentColor" d="M10 12.796L4.5 8L10 3.204v9.592z"/></svg>
                    上一页
                </button>
                <div class="page-info">
                    <span id="currentPage">1</span> / <span id="totalPages">1</span>
                </div>
                <button class="btn" id="nextBtn" title="下一页">
                    下一页
                    <svg width="16" height="16" viewBox="0 0 16 16"><path fill="currentColor" d="M6 3.204L11.5 8L6 12.796V3.204z"/></svg>
                </button>
            </div>

            <div class="page-input-container">
                跳转: <input type="number" class="page-input" id="pageJump" min="1" value="1">
                <button class="btn btn-primary" id="jumpBtn">确定</button>
            </div>

            <button class="btn btn-danger" id="exitBtn" title="结束放映">
                <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z"/></svg>
                结束
            </button>
        </div>

        <div class="thumbnail-container" id="thumbContainer">
            <!-- 缩略图将通过 JS 动态渲染 -->
        </div>
    </div>

    <script type="module">
        console.log('[PPTUI] 脚本开始加载...');
        
        // 增加全局错误捕获
        window.onerror = function(msg, url, line, col, error) {
            console.error('[PPTUI] 运行时错误:', msg, '\nURL:', url, '\nLine:', line, '\nError:', error);
            return false;
        };

        try {
            import Message, { EVENTS } from '../message.js';
            import '../ipc_bridge.js'; 
            console.log('[PPTUI] 模块导入完成');
            
            initController(Message, EVENTS);
        } catch (err) {
            console.error('[PPTUI] 模块导入失败:', err);
        }

        function initController(Message, EVENTS) {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const jumpBtn = document.getElementById('jumpBtn');
            const exitBtn = document.getElementById('exitBtn');
            const pageJump = document.getElementById('pageJump');
            const currentPageSpan = document.getElementById('currentPage');
            const totalPagesSpan = document.getElementById('totalPages');
            const thumbContainer = document.getElementById('thumbContainer');
            const panel = document.getElementById('panel');

            let state = {
                current: 1,
                total: 1,
                thumbnails: []
            };

            let updateScheduled = false;

            function scheduleUpdate() {
                if (updateScheduled) return;
                updateScheduled = true;
                requestAnimationFrame(() => {
                    updateUI();
                    updateScheduled = false;
                });
            }

            function updateUI() {
                if (currentPageSpan.textContent != state.current) {
                    currentPageSpan.textContent = state.current;
                    pageJump.value = state.current;
                }
                if (totalPagesSpan.textContent != state.total) {
                    totalPagesSpan.textContent = state.total;
                    pageJump.max = state.total;
                }
                
                prevBtn.disabled = state.current <= 1;
                nextBtn.disabled = state.current >= state.total;

                renderThumbnails();
            }

            function renderThumbnails() {
                const fragment = document.createDocumentFragment();
                const displayThumbs = state.thumbnails && state.thumbnails.length > 0 
                    ? state.thumbnails 
                    : new Array(state.total).fill(null);

                displayThumbs.forEach((thumb, index) => {
                    const pageNum = index + 1;
                    const item = document.createElement('div');
                    const isActive = pageNum === state.current;
                    item.className = `thumbnail-item${isActive ? ' active' : ''}${!thumb ? ' loading' : ''}`;
                    item.innerHTML = `
                        <img src="${thumb || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='}" alt="第${pageNum}页">
                        <div class="thumbnail-num">${pageNum}</div>
                    `;
                    item.onclick = () => gotoPage(pageNum);
                    fragment.appendChild(item);

                    if (isActive) {
                        setTimeout(() => {
                            item.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                        }, 100);
                    }
                });

                thumbContainer.innerHTML = '';
                thumbContainer.appendChild(fragment);
            }

            function gotoPage(num) {
                const page = parseInt(num);
                if (isNaN(page) || page < 1 || page > state.total) return;
                Message.emit(EVENTS.COM_GOTO_PAGE, { page });
            }

            // 按钮事件
            prevBtn.onclick = () => gotoPage(state.current - 1);
            nextBtn.onclick = () => gotoPage(state.current + 1);
            jumpBtn.onclick = () => gotoPage(pageJump.value);
            pageJump.onkeydown = (e) => {
                if (e.key === 'Enter') gotoPage(pageJump.value);
            };
            exitBtn.onclick = () => {
                if (confirm('确定要结束 PPT 放映联动吗？')) {
                    Message.emit(EVENTS.PPT_EXIT);
                }
            };

            // 监听状态同步
            const handleSync = (data) => {
                console.log('[PPTUI] 状态同步更新:', data);
                if (data && (data.currentSlide || data.current)) {
                    state.current = data.currentSlide || data.current;
                    state.total = data.totalSlides || data.total || state.total;
                    if (data.thumbnails) state.thumbnails = data.thumbnails;
                    scheduleUpdate();
                }
            };

            Message.on(EVENTS.COM_SYNC_STATE, handleSync);
            Message.on(EVENTS.PPT_SYNC_STATE, handleSync);
            Message.on(EVENTS.VSTO_SYNC_STATE, handleSync);

            if (window.electronAPI && window.electronAPI.onReplyFromMain) {
                window.electronAPI.onReplyFromMain('ppt:sync-state', handleSync);
                window.electronAPI.onReplyFromMain('com:sync-state', handleSync);
            }

            // 初始入场动画
            panel.classList.remove('fade-enter');
            console.log('[PPTUI] 控制器初始化完成');
        }
    </script>
</body>
</html>
